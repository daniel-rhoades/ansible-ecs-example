---
- name: EC2 | Provision networking | Create Inbound Security Groups
  local_action:
    module: ec2_group
    name: "{{ item.sg_name }}"
    description: "{{ item.sg_description }}"
    region: "{{ vpc_region }}"
    vpc_id: "{{ vpc.vpc_id }}"
    state: present
    rules: "{{ item.sg_rules }}"
  with_items: "{{ inbound_security_groups }}"
  register: ec2_group_inbound_sg

- set_fact: "inbound_app_sg={{ ec2_group_inbound_sg.results[0].group_id }}"

- set_fact: "inbound_ssh_sg={{ ec2_group_inbound_sg.results[1].group_id }}"

- name: EC2 | Provision networking | Create Outbound Security Groups
  local_action:
    module: ec2_group
    name: "{{ item.sg_name }}"
    description: "{{ item.sg_description }}"
    region: "{{ vpc_region }}"
    vpc_id: "{{ vpc.vpc_id }}"
    state: present
    rules_egress: "{{ item.sg_rules }}"
  with_items: "{{ outbound_security_groups }}"
  register: ec2_group_outbound_sg

- set_fact: "outbound_sg={{ ec2_group_outbound_sg.results[0].group_id }}"

- name: EC2 | Provision networking | Tag Security Groups
  local_action:
    module: ec2_tag
    resource: "{{ item.group_id}}"
    region: "{{ vpc_region }}"
    state: present
    tags:
      Name: "{{ vpc_name }}-{{ item.item.sg_name }}"
  with_items:
    - "{{ ec2_group_inbound_sg.results }}"
    - "{{ ec2_group_outbound_sg.results }}"